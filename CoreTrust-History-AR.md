# تقرير: قصة TrollStore وكسر سلسلة الثقة في iOS

## المصطلحات الأساسية (قبل الدخول في التقرير)

* **مصطلح: CoreTrust**
هو مكوّن محوري داخل iOS مرتبط بسلسلة الثقة والتحقق من التواقيع والشهادات. يدخل عمليًا في قرار: هل هذا التوقيع/السلسلة تُعتبر موثوقة بما يكفي ليُسمح للتطبيق بالتثبيت والتنفيذ ضمن سياسات النظام؟

* **مصطلح: AMFI — Apple Mobile File Integrity**
هي طبقة حماية تتحكم في قبول/رفض تشغيل الملفات والتطبيقات بناءً على سلامة التوقيع والسياسات. تقدر تعتبرها “شرطي التنفيذ” الذي يطبق قواعد Apple على ما يُسمح بتشغيله.

* **مصطلح: Entitlements**
هي صلاحيات موقّعة داخل التطبيق تحدد قدرته على الوصول لواجهات أو قدرات حساسة. كثير منها لا يُمنح إلا لتطبيقات النظام أو تطبيقات موقّعة بشروط معينة لأنها تفتح نطاق وصول أكبر من الطبيعي.

* **مصطلح: Perma-signed (تثبيت دائم)**
هو وصف شائع في المجتمع لمعنى: التطبيق يبقى مثبتًا ويعمل بدون الحاجة لإعادة توقيعه كل فترة. الأهم هنا “النتيجة العملية للمستخدم”: استمرار عمل التطبيق بشكل دائم.

* **مصطلح: SPTM - Secure Page Table Monitor**
هي حماية حديثة تم إضافتها في بداية IOS 17 وهي حماية هجينة اي هي ليست حماية Software او Hardware تماما بل هي جزء Hardware وجزء Software وقوتها الأساسية هي انها Hardware حيث يتطلب كسرها التعامل مع عتاد الجهاز.

* **مصطلح: التثبيت من خارج المتجر (Sideloading)**
هو تثبيت تطبيقات iOS من خارج متجر App Store بطرق مختلفة (مثل ملفات IPA). غالبًا يكون مقيدًا بقيود التوقيع أو مدة الصلاحية حسب الطريقة المستخدمة.

* **مصطلح: CVE**
هو معرّف رسمي للثغرات الأمنية (Common Vulnerabilities and Exposures) يُستخدم لتوثيق الثغرات وتتبعها وربطها بالإصلاحات عبر الإصدارات.

## القسم 1.0 - البداية

هذا تقرير عن قصة TrollStore

كيف قدر يحقق تثبيت دائم لتطبيقات IPA بدون جيلبريك كامل؟
كيف ظهرت ثغرة داخل CoreTrust على مرحلتين مختلفتين (TrollStore 1 ثم TrollStore 2) مع أن النتيجة النهائية كانت متشابهة؟ وماهي الفروقات بينهم ؟

بكلمات بسيطة: ما الذي انكسر داخل سلسلة الثقة؟ وكيف أعاد المجتمع استخدام نفس الفكرة لما ظهر خلل جديد داخل نفس المنطقة؟

## القسم 1.1 - وش هو TrollStore؟

**مشروع: TrollStore** هو آلية تسمح لك تثبّت وتشغّل ملفات IPA بشكل دائم (Perma-signed من منظور المستخدم).
لكن خلونا نكون دقيقين: هو ما يكسر النظام بالكامل مثل الجيلبريك، بل يستفيد من خلل في سلسلة الثقة المرتبطة بالتوقيع بحيث يقبل iOS توقيعًا بطريقة غير متوقعة… وبعدها يصير قادر يثبّت تطبيقات بشكل دائم وبصلاحيات أعلى (بحسب entitlements).

### القسم 1.1.1 - ليش البعض يفضلوه عن الجيلبريك ؟

لأنه قدّم منتصف الطريق المثالي لكثير ناس:
- تثبيت دائم لتطبيقات/أدوات
- بدون فتح كل بوابات الجيلبريك ومخاطره
- وبنفس الوقت يعطي مساحة كبيرة للأدوات القوية (حسب الصلاحيات والـ entitlements)

## القسم 1.2 - نسختين بس الفكرة واحدة

أغلب الناس يقسمونه كذا (تقسيم عام أكثر من كونه مشروعين منفصلين):

* **مشروع: TrollStore 1**
  * نطاقه كان تقريبًا: iOS 14.0 → iOS 15.4.1 (وممكن بعض بيتا iOS 15.5)
  * يعتمد على ثغرة: `CVE-2022-26766` (Linus Henze)

* **مشروع: TrollStore 2**
  * رجّع نفس الفكرة/النتيجة على إصدارات أحدث عبر ثغرة: `CVE-2023-41991`
  * ودعم نطاقًا واسعًا يصل إلى: 14.0 beta 2 → 16.6.1 + 16.7 RC + 17.0

> **ملاحظة مهمة جدًا:**
> الدعم يشتغل على إصدار/جهاز شيء ويوجد طريقة تثبيت مناسبة لكل جهاز/إصدار شيء ثاني لأن التثبيت يحتاج مدخل يختلف حسب الإصدار والبيئة.

## القسم 1.3 - مين اللي اشتغل عليه؟ ومين اكتشف الثغرات؟

* **المطوّر الرئيسي:** opa334
* **المكتشفون (الأهم في القصة):**
  * ثغرة: `CVE-2022-26766` - Linus Henze
  * ثغرة: `CVE-2023-41991` - Citizen Lab + Google TAG

## القسم 1.4 - كيف صارت في CoreTrust مرتين؟

الجواب: هي ما تكررت حرفيًا بنفس التفاصيل اللي تكرر هو المكان (CoreTrust)، لكن نوع الخطأ مختلف.
الفكرة الأدق:
تكررت النتيجة (تجاوز قواعد التوقيع) لكن عبر ثغرات مختلفة داخل نفس المكوّن.

### القسم 1.4.1 - نسخة: TrollStore 1 (منطق الثقة العالية / السلسلة)
ثغرة: `CVE-2022-26766` ارتبطت بفكرة خطيرة: إمكانية تمرير حالة ثقة أو سلسلة ثقة بشكل يرفع مستوى قبول النظام للتوقيع، فيظهر التطبيق كأنه أقرب لفئة موثوق عاليًا أكثر مما ينبغي وبالتالي يحصل على مساحة صلاحيات غير متوقعة.

### القسم 1.4.2 - نسخة: TrollStore 2 (منطق تعدد التواقيع)
ثغرة: `CVE-2023-41991` كانت من نوع مختلف: خلل في آلية التحقق عندما تكون بعض الملفات موقعة بأكثر من signer، ما يؤدي لقبول توقيع بطريقة غير صحيحة ويعيد إنتاج نفس النتيجة النهائية: تجاوز قواعد التوقيع/التحقق داخل CoreTrust.

### القسم 1.4.3 - ليش Apple تعاملت مع CVE-2023-41991 بجدّية؟
لأن ثغرة: `CVE-2023-41991` ارتبطت بسلاسل استغلال بشكل حقيقي (يعني تم استغلالها فعليا من قبل منظمات تجسس) ووجود جهات مثل Google TAG وCitizen Lab في القصة رفع حساسية الموضوع لأنها عادةً تظهر عندما يكون الاستغلال حقيقيًا وعمليًا وليس مجرد نظرية او اكتشاف من قبل باحث امني.

## القسم 1.5 - تبسيط الفكرة: CoreTrust + AMFI

خلونا نبسطها:
* مصطلح: **AMFI** هو سلامة الملفات والتوقيع على iOS.
* مصطلح: **CoreTrust** يساعد في تحديد هل التوقيع/سلسلة الثقة تعتبر مقبولة وموثوقة ضمن النظام.

الفكرة الأساسية: إذا قدرت تخلي النظام يقتنع أن تطبيقك موثوق بالطريقة الغلط فجأة أبواب entitlements تتفتح لك.
وهنا جاء TrollStore: استغل خلل ثقة/تحقق وخلّى التثبيت الدائم ممكن بدون جيلبريك.

## القسم 1.6 - طيب وش يفرق عن الجيلبريك؟

* **الجيلبريك:** يروح بعيد (تعديل نظام/كسر اغلب الحمايات/تويكات بصلاحيات عالية).
* **مشروع: TrollStore** يعطيك تثبيت دائم ومساحة entitlements، لكن ما يحوّل جهازك تلقائيًا لجهاز مكسور الحماية.

يعني باختصار: هو Super Sideload مبني على خلل ثقة مو كسر كامل للنظام.

## القسم 1.7 - طرق تثبيت TrollStore

الفكرة: TrollStore يعتمد على خلل داخل CoreTrust، لكن المشكلة العملية دائمًا كانت: كيف نثبته أول مرة؟
عشان كذا ظهر مشهد أدوات في المجتمع كل أداة تستغل مدخل مختلف حسب الجهاز والإصدار، ثم توصل لنفس الهدف: إدخال TrollStore وتثبيته وتشغيله بشكل مستقر.

* **أداة: TrollInstallerX**
  * **الدور:** مثبت عام هدفه يغطي نطاقات أوسع قدر الإمكان بدل ما تحتاج أداة مختلفة لكل فترة.
  * **الاعتماد:** يعتمد على توفر مدخل مناسب في النظام/الإصدار يسمح بتمرير عملية التثبيت (المدخل يختلف حسب النسخة والجهاز)، ثم يستخدمه لإكمال تثبيت TrollStore.
  * **ليش يهم؟** لأنه يقلل التشتيت: بدل 3–4 حلول مختلفة، يعطيك خيار واحد يغطي حالات كثيرة (لكن مو كل الحالات).

* **أداة: TrollInstallerMDC**
  * **الدور:** مثبت مرتبط بفترة اشتهرت فيها حلول مبنية على ثغرة MacDirtyCow.
  * **الاعتماد:** يعتمد على مدخل من نوع MacDirtyCow (الفكرة: استغلال سلوك/خلل يسمح بتعديل أشياء على مستوى النظام ضمن حدود معينة)، ثم يُستخدم كجسر لتجهيز و تنفيد تثبيت TrollStore.
  * **ليش يهم؟** لأنه كان “أفضل مدخل” في فترته لبعض نطاقات iOS، خصوصًا لما كانت خيارات التثبيت قليلة.

* **أداة: TrollHelper**
  * **الدور:** مساعد في المشهد أكثر من كونه مثبت شامل يُستخدم كحل وسيط بحسب القناة المتاحة في ذلك الإصدار.
  * **الاعتماد:** يعتمد على سياق/مدخل متاح في بيئة معينة يسمح بإدخال TrollStore أو تفعيل جزء الاستمرارية (حسب ما تسمح به البيئة).
  * **ليش يهم؟** لأنه كان خيارًا مشهورًا وبسيطًا للناس في فترات معينة، خصوصًا عندما كانت المداخل محدودة أو الناس تفضّل حلول أخف.

## القسم 1.8 - فكرة: TrollRestore (الفكرة العبقرية ، سياق الاستعادة)

**فكرة: TrollRestore** اعتمدت على مسار النسخ الاحتياطي/الاستعادة كسياق نظامي يختلف فيه التعامل مع بعض القيود، وبكذا صار ممكن فتح الباب لتثبيت TrollStore في نطاقات معينة كانت المشكلة فيها غالبًا كيف تدخل، أكثر من كونها هل الخلل موجود (وهنا نقصد اصدارات 17.0 لان ثغرة CoreTrust كانت موجودة فعليا ولكن كل طرق التثبيت مثل KFD و TrollInstallerX تم اغلاقها تماما وهنا ظهرت فكرة TrollRestore).

الفكرة العامة: في iOS مو كل المراحل تتعامل مع الملفات والتطبيقات بنفس الشدة.
أثناء الاستخدام اليومي، القيود تكون قاسية لأن النظام يفترض إن أي شيء جديد لازم يمر عبر مسارات تحقق صارمة (توقيع/ثقة/صلاحيات).
لكن أثناء مرحلة الاستعادة (Restore) النظام يدخل وضع مختلف: هدفه الأساسي إرجاع حالة جهاز قديمة بأكبر قدر ممكن من التطابق وهنا تظهر نقطة مهمة:

النقطة الذكية: مسار الاستعادة يتعامل مع حزم بيانات (بيانات تطبيقات + إعدادات + بنية ملفات) ويعيد بناءها على الجهاز. هذا المسار غالبًا يشغل خدمات لها صلاحيات أعلى من التطبيقات العادية، ويقوم بعمليات إعادة إنشاء بدل تثبيت تقليدي بالمعنى المعتاد.

وين كانت الثغرة/الفرصة في TrollRestore؟
الفرصة كانت في “التقاطع” بين شيئين:
* النقطة الأولى: خلل CoreTrust (اللي يسمح بالنتيجة النهائية: قبول حالة توقيع/ثقة بشكل غير صحيح)
* النقطة الثانية: سياق الاستعادة (اللي يعطي قناة إدخال مختلفة، لأن النظام يعيد بناء بيانات/ملفات داخل بيئة خدمات مو مثل مسار التثبيت اليومي)

بمعنى أوضح:
بدل ما تحاول تدخل من باب التثبيت المعتاد اللي عليه رقابة عالية، تستخدم باب إعادة الحالة/البيانات اللي أحيانًا يتعامل مع الأشياء بطريقة مختلفة ولما يكون خلل CoreTrust موجود، يصير هذا الباب كافي للوصول لنقطة تثبيت TrollStore على إصدارات كانت المشكلة فيها: كيف نوصل لمرحلة الإدخال؟

## القسم 1.9 — ثغرات ونهاية TrollStore؟

* **الثغرة الأولى: CVE-2022-26766** — خلل في CoreTrust (تحليل شهادة)
  * اتقفلت في: iOS 15.5
* **الثغرة الثانية: CVE-2023-41991** — خلل في CoreTrust (التحقق من الشهادة/تجاوز التوقيع)
  * اتقفلت في: iOS 16.7 وفي: iOS 17.0.1
* **الثغرة الثالثة: CVE-2022-46689** — MacDirtyCow (خلل Copy-On-Write في كيرنل XNU)
  * اتقفلت في: iOS 15.7.2 و iOS 16.2
* **الثغرة الرابعة: CVE-2024-44252** — خلل في مسار الاستعادة/النسخ الاحتياطي (MobileBackup)
  * اتقفلت في: iOS 17.7.1 و iOS 18.1

### القسم 1.9.1 - ما بعد TrollStore

بعد مرحلة TrollStore قامت آبل بإغلاق ثغرات CoreTrust التي استُخدمت فعليًا في TrollStoreومع إدخال آبل لطبقات حماية مثل SPTM (Secure Page Table Monitor) و TXM (Trusted Execution Monitor) في iOS 17 على أجهزة A15 وما بعده، لم تعد سيطرة kernel وحدها تعني القدرة على تعديل جداول الصفحات/صلاحيات الذاكرة أو التحكم الكامل بمنطق التحقق من التوقيع كما كان في أجيال أقدم. 

نظام SPTM هو السلطة الأساسية لحماية/إدارة page tables وعمليات memory retyping وTXM مُعزول كمكوّن مسؤول عن التحقق من التوقيع والـ entitlements ضمن تقسيمات ثقة خارج نطاق تحكم XNU المباشر.

لذلك: حتى لو ظهرت مستقبلاً ثغرة في CoreTrust تشبه سابقاتها من حيث تجاوز التحقق من التوقيع، فالحصول على نفس أثر TrollStore التاريخي (تثبيت دائم/صلاحيات واسعة بدون جيلبريك تقليدي) سيكون عادةً أصعب بكثير، لأن تحقيق أثر كامل قد يتطلب تجاوز طبقات أعلى من kernel (مثل SPTM/TXM) وليس مجرد استغلال kernel + root. ومع ذلك، لا يمكن القول أن ثغرة CoreTrust مستقبلًا لن تكون مفيدة مطلقًا لكن من المؤكد أن البيئة الحالية تجعل تكرار سيناريو TrollStore بنفس السهولة صعب جدا.

## القسم 2.0 - الخاتمة

مشروع: TrollStore كان (ولا يزال) واحد من أذكى إنجازات مجتمع الجيلبريك لأنه قدّم نقطة توازن وفكرة عبقرية:
- حرية المستخدم
- تثبيت دائم
- وتقليل المخاطرة مقارنة بكسر النظام بالكامل

وبالجانب الآخر؟ قصته تذكير مهم:
حتى الأنظمة اللي تبدو مستحيلة والتي تطبق حمايات قوية مثل CoreTrust وAMFI ممكن يطلع فيها خلل صغير في التحقق، وذا الخلل يغيّر قواعد اللعبة بالكامل القصة ما تنتهي هنا ولكنها لعبة قط وفارّ مستمرة طالما التقنية تتطور.
